# .github/workflows/release-msix.yml
name: Build & Sign MSIX

on:
  push:
    tags: ['v*.*.*']

env:
  APP_NAME: neovide-tabs
  # MSIX requires 4-part version; we'll derive from tag
  # Publisher must match your SignPath certificate subject exactly
  PUBLISHER_DISPLAY_NAME: "Keath Milligan"
  # Identity name must be unique and follow reverse-domain convention
  IDENTITY_NAME: "KeathMilligan.NeovideTabs"

jobs:
  build-and-sign-msix:
    runs-on: windows-latest
    permissions:
      contents: write  # Required for creating GitHub releases

    steps:
      - uses: actions/checkout@v4

      # ── Extract version from tag ──────────────────────────────────
      - name: Extract version
        id: version
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          # Strip 'v' prefix and ensure 4-part version for MSIX
          $version = $tag -replace '^v', ''
          $parts = $version.Split('.')
          # Pad to 4 parts (MSIX requires Major.Minor.Build.Revision)
          while ($parts.Count -lt 4) { $parts += '0' }
          $msixVersion = $parts[0..3] -join '.'
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "MSIX_VERSION=$msixVersion" >> $env:GITHUB_OUTPUT
          echo "Semantic version: $version"
          echo "MSIX version: $msixVersion"

      # ── Rust toolchain ────────────────────────────────────────────
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build release binary
        run: cargo build --release

      # ── Locate Windows SDK tools ──────────────────────────────────
      - name: Find Windows SDK
        id: sdk
        shell: pwsh
        run: |
          # Find the latest Windows SDK installation
          $sdkRoot = "C:\Program Files (x86)\Windows Kits\10\bin"
          $latestSdk = Get-ChildItem $sdkRoot -Directory | 
            Where-Object { $_.Name -match '^\d+\.\d+\.\d+\.\d+$' } |
            Sort-Object { [version]$_.Name } -Descending |
            Select-Object -First 1
          if (-not $latestSdk) {
            throw "Windows SDK not found"
          }
          $sdkBin = Join-Path $latestSdk.FullName "x64"
          echo "SDK_BIN=$sdkBin" >> $env:GITHUB_OUTPUT
          echo "Found Windows SDK at: $sdkBin"

      # ── Prepare MSIX layout ───────────────────────────────────────
      - name: Create MSIX layout
        shell: pwsh
        run: |
          # Create directory structure
          New-Item -ItemType Directory -Force -Path msix/Assets | Out-Null
          
          # Copy the built binary
          Copy-Item target/release/${{ env.APP_NAME }}.exe msix/
          
          # Copy icons:
          # neovide-tabs.png (256x256) - app icon for taskbar, start menu
          # neovide-tabs-pix.png (256x256) - display image for installer, tiles, store
          
          # App icon (taskbar, start menu small)
          Copy-Item neovide-tabs.png msix/Assets/Square44x44Logo.png
          
          # Display images (installer, tiles, store logo)
          Copy-Item neovide-tabs-pix.png msix/Assets/Square150x150Logo.png
          Copy-Item neovide-tabs-pix.png msix/Assets/Square310x310Logo.png
          Copy-Item neovide-tabs-pix.png msix/Assets/Wide310x150Logo.png
          Copy-Item neovide-tabs-pix.png msix/Assets/StoreLogo.png

      # ── Generate AppxManifest with correct version ────────────────
      - name: Generate AppxManifest.xml
        shell: pwsh
        run: |
          $manifest = Get-Content .github/msix/AppxManifest.xml -Raw
          $manifest = $manifest -replace '\$\{VERSION\}', '${{ steps.version.outputs.MSIX_VERSION }}'
          $manifest = $manifest -replace '\$\{PUBLISHER_DISPLAY_NAME\}', '${{ env.PUBLISHER_DISPLAY_NAME }}'
          $manifest = $manifest -replace '\$\{IDENTITY_NAME\}', '${{ env.IDENTITY_NAME }}'
          # Publisher CN will be replaced by SignPath during signing
          $manifest | Set-Content msix/AppxManifest.xml -Encoding UTF8
          echo "Generated manifest:"
          Get-Content msix/AppxManifest.xml

      # ── Build unsigned MSIX ───────────────────────────────────────
      - name: Pack unsigned MSIX
        shell: pwsh
        run: |
          $makeappx = Join-Path "${{ steps.sdk.outputs.SDK_BIN }}" "makeappx.exe"
          & $makeappx pack /d msix /p "target/release/${{ env.APP_NAME }}-unsigned.msix" /o
          if ($LASTEXITCODE -ne 0) { throw "makeappx failed" }

      # ── Upload unsigned artifact for SignPath ─────────────────────
      - name: Upload unsigned MSIX
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-msix
          path: target/release/${{ env.APP_NAME }}-unsigned.msix
          retention-days: 1

      # ── Sign with SignPath.io ─────────────────────────────────────
      # SignPath is free for open-source projects
      # Setup required:
      #   1. Create account at https://signpath.io
      #   2. Create organization, project, and signing policy
      #   3. Add SIGNPATH_API_KEY secret to repo
      #   4. Add SIGNPATH_ORGANIZATION_ID secret to repo
      #   5. Configure trusted build system in SignPath dashboard
      - name: Sign MSIX with SignPath
        uses: signpath/github-action-submit-signing-request@v1
        with:
          api-token: ${{ secrets.SIGNPATH_API_KEY }}
          organization-id: ${{ secrets.SIGNPATH_ORGANIZATION_ID }}
          project-slug: neovide-tabs
          signing-policy-slug: release-signing
          artifact-configuration-slug: msix
          github-artifact-id: ${{ steps.upload.outputs.artifact-id }}
          wait-for-completion: true
          output-artifact-directory: ./signed

      # ── Rename signed artifact ────────────────────────────────────
      - name: Rename signed MSIX
        shell: pwsh
        run: |
          # SignPath outputs with original name; rename to final name
          $signedFile = Get-ChildItem ./signed -Filter "*.msix" | Select-Object -First 1
          if ($signedFile) {
            $newName = "${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}.msix"
            Rename-Item $signedFile.FullName -NewName $newName
            echo "Renamed to: $newName"
          }

      # ── Create .appinstaller for easy web installation ────────────
      # This enables one-click install and auto-updates from GitHub releases
      - name: Create .appinstaller
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.MSIX_VERSION }}"
          $tag = "${{ github.ref_name }}"
          $repo = "${{ github.repository }}"
          # NOTE: Publisher CN must match your SignPath certificate exactly
          # Update this after you receive your signing certificate
          $publisherCN = "CN=${{ env.PUBLISHER_DISPLAY_NAME }}"
          
          @"
          <?xml version="1.0" encoding="utf-8"?>
          <AppInstaller Uri="https://github.com/$repo/releases/download/$tag/${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}.msix"
                        Version="$version"
                        xmlns="http://schemas.microsoft.com/appx/appinstaller/2018">
            <MainPackage Name="${{ env.IDENTITY_NAME }}"
                         Publisher="$publisherCN"
                         Version="$version"
                         ProcessorArchitecture="x64"
                         Uri="https://github.com/$repo/releases/download/$tag/${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}.msix" />
            <UpdateSettings>
              <OnLaunch HoursBetweenUpdateChecks="24" ShowPrompt="true" UpdateBlocksActivation="false"/>
            </UpdateSettings>
          </AppInstaller>
          "@ | Out-File -Encoding utf8 "signed/${{ env.APP_NAME }}.appinstaller"

      # ── Create GitHub Release ─────────────────────────────────────
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            signed/${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}.msix
            signed/${{ env.APP_NAME }}.appinstaller
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          body: |
            ## Installation
            
            ### Option 1: Direct MSIX Install
            Download `${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}.msix` and double-click to install.
            
            ### Option 2: App Installer (Auto-Updates)
            Download `${{ env.APP_NAME }}.appinstaller` for automatic update support.
            
            ### Prerequisites
            - [Neovide](https://neovide.dev) must be installed and in PATH
            
            ---
